# Installing and running Sphinx

Everything here is done with Python 3.7. We'll also assume you're on Linux.

## Installing Sphinx

Sphinx is installable using pip. (Note that the Sphinx library has a capital S.)

There are three variations for a pip install. We'll use a Python virtual environment. A virtual environment is a self-contained directory tree that contains a Python installation for a particular version of Python, plus a number of additional packages. This is handy if you use different, possibly conflicting, libraries.

To create a virtual environment, activate the environment, and install Sphinx, do the following. Start in your home directory. (You don't have to deactivate at the end, it's there for completeness.)

```
$ python3 -m venv sphinx-env
$ source sphinx-env/bin/activate
(sphinx-env) $ python -m pip install Sphinx
... lots of pip messages ...
(sphinx-env) $ deactivate
$
```

The `sphinx-env` directory defines your virtual environment. Don't put arbitary files in there.

You can also install per-user (`$ python -m pip install --user Sphinx`), or install globally (requires root) (`# python -m pip install Sphinx`), but we'll prefer venv.

## Building the documentation

Make sure your Sphinx venv is activated (using the `source sphinx-env/bin/activate` command as shown above). From now on, assume that sphinx-env is activated.

First, set up Sphinx. (We'll basically follow the [Sphinx quickstart page](https://www.sphinx-doc.org/en/master/usage/quickstart.html).)

Make a directory called `doc-build` and change into it. Run the command `sphinx-quickstart` and answer the questions as below. This will configure an initial setup. Don't worry too hard about the answers, they're all in a config file that you can change later, but we definitely want separate source and build directories.

```
Separate source and build directories: y
Project name: Constellation
Author name(s): Dr Strange
Project release: 1.99
Project language: en
```

Look at `source/conf.py` to see where your answers ended up. Edit it, look for `html_theme` near the bottom, and change the value to `'bizstyle'` instead of `'alabaster'`. If you like you can run `make html` and inspect the output in the build directory. (The `conf.py` file should be added to the git repo containing the documentation source, so the entire source directory can be checked out in one go.)

The source directory contains the `.rst` files and resources we'll use to build the documentation. We'll ignore the `_static` and `_templates` directories, and we're about to overwrite the `index.rst` file.

Add the documentation sources to the source directory. One way of doing this is to clone the repo wherever you like, and make 'source' a symbolic link to the clone. Or you can zip the files somewhere else, and unzip them into source. (If you're copying the output from the HTML to ReST converter, copy the contents of the output directory into the source directory.) Either way, the source directory must contain the files `conf.py` and `index.rst`, as well as the various directories containing the documentation sources.

Run `make clean` to remove the output from when you ran `make html` above.

Run `make html` to build the documentation. Assuming everything goes well, the final line of output should be "`The HTML pages are in build/html.`"

The Sphinx part is complete, however, NetBeans requires another step. The Constellation code uses helpIds to identify help pages. We want to keep doing this, because we don't want to have to specify the help layout in the code. And also, we don't want to change massive amounts of code. This is what the `help_map.txt` file does; it's a two column CSV file that maps a helpId to a help page. It must be present so the help displayer knows how to convert a helpId to a document page.

The `help_map.txt` is generated by the `make_mappings.py` script. Each `.rst` file generated by the HTML to ReST script contains a special ReST comment with the helpId in it. As long as every new `.rst` file contains its unique helpId, `make_mappings.py` can automaticaly generate the `help_map.txt` file.

For example:

```
.. help-id: this.is.the.help.id
```

Obviously not every `.rst` file needs a helpId; just the ones that are targets of help.

To generate `help_map.txt`, change to the directory with `source` and `build` in it, and run this.

```
python make_mappings.py --indir source --out build/help_map.txt
```

The `build` directory should now contain `help_map.txt` and the `html` and `doctrees` directories.

Delete the `build/doctrees` directory; this contains stuff that was used for the build, and isn't required.

Change into the build directory and zip the contents. THis produces a zip archive with the files in their correct places.

```
(sphinx-env) $ cd build
(sphinx-env) $ zip -rv9 /tmp/help.zip .
```

The resulting `.zip` file can now be used by Constellation.

## Multiple help sources

Constellation is designed to be layered. For example, some one might write a roads project containing modules specifically for working with road networks. These modules will have their own helpIds and help `.rst` files and resources.

To combine the different help sources, copy them all to the same `source` directory. The order of copying depends on what you want to do. If the road project's help files are disjoint from the Constellation files, copy them in any order. If the road project's help files overlap (maybe they reword some of the core help in terms of road networks for easier understanding by users), then copy rail network help over the top of core help.

Then do the build.

## Deploying the `help.zip` file

See the javadoc for the `au.gov.asd.tac.constellation.webserver.help` package for instructions on where to deploy the `help.zip` file.
